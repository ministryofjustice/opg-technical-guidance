name: Publish Docs

on:
  push:
    branches:
      - "main"
    paths-ignore:
      - "docs/**"
  schedule:
    # Every Tuesday, at 9.15am
    - cron: '15 9 * * 2'

jobs:
    build_and_publish:
      runs-on: ubuntu-latest
      container:
        image: ministryofjustice/tech-docs-github-pages-publisher:1.3
      steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: Create artifact directory
        run: mkdir -p ./artifacts/
      - name: Download python report artifacts
        uses: dawidd6/action-download-artifact@v2.14.0
        continue-on-error: true
        with:
          workflow: python-reports.yml
          workflow_conclusion: success
          branch: main
          path: ./artifacts/
      - name: Download amalgamated repository scan report artifacts
        uses: dawidd6/action-download-artifact@v2.14.0
        continue-on-error: true
        with:
          workflow: amalgamated-package-scan.yml
          workflow_conclusion: success
          branch: main
          path: ./artifacts/
      - name: Set up Python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - name: Create erb file for repo scan report
        run: |
          ls -lart ./stubs/
          ls -lart ./artifacts/*
          stub='./stubs/amalgamated_package_scan_report'
          report='./artifacts/amalgamated_package_scan_report/report.v1.0.0.md'
          dest='./artifacts/amalgamated_package_scan_report/repository_package_report.html.md.erb'
          d="${{ steps.date.outputs.date }}"
          python -c "stub = open('${stub}').read().replace('{{date}}','${d}'); report = open('${report}').read(); content = stub.replace('{{report}}', report); open('${dest}', 'w').write(content);"
      - name: Checkout to pages branch
        run: git checkout -b gh-pages
      - name: List and move *.erb artifacts if they exist
        run: |
          ls -lart ./artifacts/*
          if [ -d ./artifacts ]; then
            echo "Artifact directory found."
            find ./artifacts -type f -name "*.erb" -exec mv {} ./source/documentation \;
          fi
      - name: Build
        run: bundle exec middleman build --build-dir docs --relative-links 2>/dev/null
      - run: touch docs/.nojekyll
      - run: echo "${GITHUB_SHA}" > docs/version.txt
      - run: cd docs && echo 'docs.opg.service.justice.gov.uk' >CNAME
      - run: git config --global user.email "tools@digital.justice.gov.uk"
      - run: git config --global user.name "Github Action"
      - run: git add docs
      - run: git status
      - run: git commit -m "Published at $(date)"
      - run: git push origin gh-pages --force
