name: Publish Docs

on:
  push:
    branches:
      - "main"
    paths-ignore:
      - "docs/**"
  schedule:
    # Every Tuesday, at 9.15am
    - cron: '15 9 * * 2'

jobs:
  build_and_publish:
    runs-on: ubuntu-latest
    container:
      image: ministryofjustice/tech-docs-github-pages-publisher:1.3
    steps:
    - name: checkout
      uses: actions/checkout@v2
    - name: Download reports from artifacts
      uses: actions/download-artifact@v2
      with:
        path: artifacts
    - name: List and move artifacts if they exist
      run: |
        ls -lart
        if [ -d artifacts ]; then
          ls -lart artifacts*
          find ./artifacts -type f -name "*.html.md.erb" -exec mv {} ./source/documentation \;
        fi
    - name: Build
      run: bundle exec middleman build --build-dir docs --relative-links 2>/dev/null
    - run: touch docs/.nojekyll
    - run: cd docs && echo 'docs.opg.service.justice.gov.uk' >CNAME
    - run: git config --global user.email "tools@digital.justice.gov.uk"
    - run: git config --global user.name "Github Action"
    - run: git checkout -b gh-pages
    - run: git add docs
    - run: git commit -m "Published at $(date)"
    - run: git push origin gh-pages --force
